{% extends "base.html" %}

{% import "bootstrap/wtf.html" as wtf %}

{% block title %}
Event Frames
{% endblock %}

{% block page_content %}
<div>
    <ol class = "breadcrumb">
        <li class = "active"><span class = "glyphicon glyphicon-home"></li>
    </ol>
</div>
{% if form %}
    <div class = "page-header">
            <h1>Event Frame Overlay <small>Date Range</small></h1>
    </div>
    <div>
        <button class = "btn btn-primary" id = "buttonMonthPicker3" months = "1" title = "1 Month">1 Mo</button>
        <button class = "btn btn-primary" id = "buttonMonthPicker3" months = "3" title = "3 Months">3 Mo</button>
        <button class = "btn btn-primary" id = "buttonMonthPicker6" months = "6" title = "6 Months">6 Mo</button>
        <button class = "btn btn-primary" id = "buttonMonthPicker9" months = "9" title = "9 Months">9 Mo</button>
        <button class = "btn btn-primary" id = "buttonMonthPicker12" months = "12" title = "1 Year">1 Yr</button>
    </div>
    <div>
        {{ wtf.quick_form(form) }}
    </div>
{% else %}
    <div class = "page-header">
            <h1>Event Frame Overlay <small>Selection</small></h1>
    </div>
    <div>
        Toggle Column:
        {% for eventFrameAttributeTemplate in eventFrameAttributeTemplates %}
            {% set dataColumn = loop.index + 4 %}
            <button type = "button" class = "btn btn-primary btn-xs" dataColumn = "{{ dataColumn }}"
                id = "buttonToggleColumn{{ eventFrameAttributeTemplate.Name }}">{{ eventFrameAttributeTemplate.Name }}</button>
        {% endfor %}
    </div>
    <br>
    <a class = "btn btn-default" id = "buttonEventFrameOverlay" title = "Add"><span class = "glyphicon glyphicon-stats"></span></a>
    <br><br>
    <div>
        <table id = "table" class = "table">
            <thead>
                <tr>
                    <th>Event Frame Id</th>
                    <th>Name</th>
                    <th>Element</th>
                    <th>Start</th>
                    <th>End</th>
                    {% for eventFrameAttributeTemplate in eventFrameAttributeTemplates %}
                        <th>{{ eventFrameAttributeTemplate.Name }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for eventFrame in eventFrames %}
                    <tr class = "trEventFrame" eventFrameId = "{{ eventFrame.EventFrameId }}">
                        <td>{{ eventFrame.EventFrameId }}</td>
                        <td>{{ eventFrame.Name }}</td>
                        <td>{{ eventFrame.Element }}</td>
                        <td>{{ eventFrame.Start }}</td>
                        {% if eventFrame.End %}
                            <td>{{ eventFrame.End }}</td>
                        {% else %}
                            <td></td>
                        {% endif %}
                        {% for eventFrameAttributeTemplate in eventFrameAttributeTemplates %}
                            <td>{{ eventFrame[eventFrameAttributeTemplate.Name] }}</td>
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr>
                    <th>Event Frame Id</th>
                    <th>Name</th>
                    <th>Element</th>
                    <th id = "thStartTimestamp">Start</th>
                    <th id = "thEndTimestamp">End</th>
                    {% for eventFrameAttributeTemplate in eventFrameAttributeTemplates %}
                        <th>{{ eventFrameAttributeTemplate.Name }}</th>
                    {% endfor %}
                </tr>
            </tfoot>
        </table>
    </div>
{% endif %}
{% endblock %}

{% block scripts %}
    {{ super() }}
    <link rel = "stylesheet" type = "text/css" href = {{ url_for("static", filename = "css/datatables.min.css") }}/>Â 
    <link rel = "stylesheet" type = "text/css" href = {{ url_for("static", filename = "css/styles.css") }}/>
    <script type = "text/javascript" src = {{ url_for("static", filename = "js/datatables.min.js") }}></script>
    <script type = "text/javascript" src = {{ url_for("static", filename = "js/moment.min.js") }}></script>
    <script> 
        $(document).ready(function()
        {
            {% if form %}
                $(".form-control").first().focus()
                $("#submit").hide()
                $("#submit").parent().append("<button class = \"btn btn-default\" title = \"Search\" type = \"submit\">" +
                    "<span class = \"glyphicon glyphicon-search\" aria-hidden = \"true\"></span></button>")
            {% endif %}

            // Setup - add a text input to each footer cell
            $("#table tfoot th").each(function ()
            {
                var id = $(this).attr("id")
                var title = $(this).text()
                if (id != "thStartTimestamp" && id != "thEndTimestamp")
                {
                    $(this).html("<input type = \"text\" placeholder = \"Search " + title + "\" />")
                }
                else
                {
                    $(this).html("")
                }
            })

            var table = $("#table").DataTable
            ({
                "columnDefs":
                [
                    {
                        // Hide the EventFrameId.
                        "targets": [0],
                        "visible": false
                    }
                ],
                "order":
                [
                    [3, "desc"],             // Start timestamp.
                ],
                "stateSave": true,
                "stateDuration": 0,
                "pageLength": 10
            })

            $("[id^=buttonToggleColumn]").on("click", function (e)
            {
                e.preventDefault();
        
                // Get the column API object
                var column = table.column($(this).attr("dataColumn"))
        
                // Toggle the visibility
                column.visible(!column.visible())

                if ($(this).hasClass("active"))
                {
                    $(this).removeClass("active")
                }
                else
                {
                    $(this).addClass("active")
                }
            })

            $("#buttonEventFrameOverlay").on("click", function (e)
            {
                {% if eventFrameTemplate %}
                    var link = "http://localhost:3000/d/EventFramesOverlay/event-frames-overlay?orgId=1" +
                        "&var-enterprise={{ eventFrameTemplate.ElementTemplate.Site.Enterprise.EnterpriseId }}" +
                        "&var-site={{ eventFrameTemplate.ElementTemplate.Site.SiteId }}" +
                        "&var-elementTemplate={{ eventFrameTemplate.ElementTemplate.ElementTemplateId }}" + 
                        "&var-eventFrameTemplate={{ eventFrameTemplate.EventFrameTemplateId }}"
                    table.rows({filter: "applied"}).every(function()
                    {
                        link = link + "&var-eventFrames=" + this.data()[0]
                    })
                    link = link + "&var-eventFrameAttributeTemplates=All&var-lookups=All"
                    window.open(link, "_blank");
                {% endif %}
            })

            // Apply the search
            table.columns().every(function ()
            {
                // Clear any left over filtering from state saving.
                this.search("", 1).draw()

                var that = this
        
                $("input", this.footer()).on("keyup change", function ()
                {
                    if ( that.search() !== this.value )
                    {
                        that.search(this.value, 1).draw()
                    }
                })

                if (this.visible())
                {
                    $(".btn.btn-primary.btn-xs[datacolumn = " + this.index() + "]").addClass("active")
                }
                else
                {
                    $(".btn.btn-primary.btn-xs[datacolumn = " + this.index() + "]").removeClass("active")
                }
            })

            $("[id^=buttonMonthPicker]").click(function()
            {
                var months = $(this).attr("months")
                $("#startTimestamp").val(new moment().subtract(months, "months").hours(0).minutes(0).seconds(0).local().format("YYYY-MM-DD HH:mm:ss"))
                $("#endTimestamp").val("")
            })
        })
    </script>
{% endblock %}
